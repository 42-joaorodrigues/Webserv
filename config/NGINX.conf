# ===========================================
# COMPLETE WEBSERV CONFIGURATION
# Showcasing all possible features and options
# ===========================================

# ===================
# Server 1 - Main Server (Default)
# ===================
server {
    # Basic server configuration
    listen 127.0.0.1:8080;
    server_name webserv.local localhost default.local;

    # Document root and default files
    root ./www;
    index index.html index.htm default.html;

    # Client request limits
    client_max_body_size 10M;

    # Error pages for all possible HTTP status codes
    error_page 400 /errors/400/400.html;
    # error_page 401 /errors/401/401.html;
    # error_page 403 /errors/403/403.html;
    error_page 404 /errors/404/404.html;
    # error_page 405 /errors/405/405.html;
    # error_page 408 /errors/408/408.html;
    # error_page 413 /errors/413/413.html;
    # error_page 414 /errors/414/414.html;
    # error_page 500 /errors/500/500.html;
    # error_page 501 /errors/501/501.html;
    # error_page 502 /errors/502/502.html;
    # error_page 503 /errors/503/503.html;
    # error_page 504 /errors/504/504.html;
    # error_page 505 /errors/505/505.html;

    # ===================
    # Location Blocks - Ordered by specificity
    # ===================

    # API endpoint with strict method control
    location /api {
        allow_methods GET POST DELETE;
        root ./www/api;
        index api.html;
        autoindex off;
    }

    # File upload endpoint
    location /upload {
        allow_methods POST;
        upload_store ./uploads;
        root ./www/upload;
        index upload.html;
    }

    # Large file upload with higher size limit
    location /upload/large {
        allow_methods POST;
        upload_store ./uploads/large;
        client_max_body_size 100M;
    }

    # Admin area with GET only
    location /admin {
        allow_methods GET;
        root ./www/admin;
        index admin.html dashboard.html;
        autoindex off;
    }

    # Public files with directory listing enabled
    location /files {
        allow_methods GET;
        root ./www;
        autoindex on;
        index README.txt index.html;
    }

    # Downloads area
    location /downloads {
        allow_methods GET;
        root ./www/downloads;
        autoindex on;
    }

    # CGI Scripts - PHP
    location /cgi-bin/php {
        allow_methods GET POST;
        root ./www/cgi;
        cgi_pass /usr/bin/php-cgi;
        cgi_extension .php;
        index index.php;
    }

    # CGI Scripts - Python
    location /cgi-bin/py {
        allow_methods GET POST;
        root ./www/cgi;
        cgi_pass /usr/bin/python3;
        cgi_extension .py;
        index index.py;
    }

    # CGI Scripts - Perl
    location /cgi-bin/pl {
        allow_methods GET POST;
        root ./www/cgi;
        cgi_pass /usr/bin/perl;
        cgi_extension .pl;
    }

    # Specific file extensions - PHP files anywhere
    location ~ \.php$ {
        allow_methods GET POST;
        cgi_pass /usr/bin/php-cgi;
        cgi_extension .php;
    }

    # Python scripts anywhere
    location ~ \.py$ {
        allow_methods GET POST;
        cgi_pass /usr/bin/python3;
        cgi_extension .py;
    }

    # Redirects - Old URLs
    location /old-site {
        return 301 http://127.0.0.1:8080/new-site;
    }

    location /legacy {
        return 302 http://127.0.0.1:8080/modern;
    }

    # Redirects with different status codes
    location /moved {
        return 301 http://127.0.0.1:8080/;
    }

    location /temporary {
        return 307 http://127.0.0.1:8080/temp-location;
    }

    # Test endpoints for different scenarios
    location /test {
        allow_methods GET POST DELETE;
        root ./www/test;
        autoindex on;
        index test.html;
    }

    location /test/get-only {
        allow_methods GET;
        root ./www/test;
        autoindex off;
    }

    location /test/post-only {
        allow_methods POST;
        root ./www/test;
        upload_store ./test-uploads;
    }

    location /test/delete-only {
        allow_methods DELETE;
        root ./www/test;
    }

    # Images and media
    location /images {
        allow_methods GET;
        root ./www;
        autoindex on;
    }

    location /media {
        allow_methods GET;
        root ./www/media;
        autoindex on;
        index media.html;
    }

    # Documentation
    location /docs {
        allow_methods GET;
        root ./www/docs;
        index README.html index.html;
        autoindex on;
    }

    # Default root location - should be last
    location / {
        allow_methods GET POST;
        index index.html index.htm default.html;
        autoindex off;
    }
}

# ===================
# Server 2 - Secondary Server (Different Port)
# ===================
server {
    listen 127.0.0.1:8081;
    server_name api.webserv.local;

    root ./www/api;
    index api.html index.json;
    client_max_body_size 1M;

    # Minimal error pages for API
    error_page 400 /errors/400.json;
    error_page 404 /errors/404.json;
    # error_page 500 /errors/500.json;

    # API endpoints
    location /v1 {
        allow_methods GET POST PUT DELETE;
        root ./www/api/v1;
        autoindex off;
    }

    location /v1/users {
        allow_methods GET POST DELETE;
        root ./www/api/v1;
    }

    location /v1/data {
        allow_methods GET POST;
        upload_store ./api-data;
    }

    # API documentation
    location /docs {
        allow_methods GET;
        root ./www/api;
        autoindex on;
        index docs.html;
    }

    # Health check
    location /health {
        allow_methods GET;
        root ./www/api;
        index health.html;
    }

    location / {
        allow_methods GET;
        autoindex off;
    }
}
